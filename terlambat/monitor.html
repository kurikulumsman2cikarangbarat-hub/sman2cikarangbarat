<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Keterlambatan Siswa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --accent: #e74c3c;
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --border: #e0e0e0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background: var(--bg-body); 
            color: var(--text-main); 
            min-height: 100vh;
            padding: 20px;
        }

        /* =========================================
           2. CONTAINER & HEADER
           ========================================= */
        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            background: transparent;
        }

        .dashboard-header {
            background: var(--bg-card);
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column; /* Mobile: Stack vertikal */
            gap: 15px;
        }

        h1 { 
            color: var(--primary); 
            font-size: 1.5rem; 
            font-weight: 700;
            display: flex; align-items: center; gap: 10px;
        }

        /* --- MODE SWITCHER (TABS) --- */
        .mode-switch-container {
            display: flex;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 4px;
            width: 100%;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-sub);
            font-weight: 600;
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* =========================================
           3. FILTER CONTROL AREA
           ========================================= */
        .controls-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        /* Mobile Default Layout */
        .controls-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: var(--text-sub); }
        
        select, .btn-check { 
            width: 100%; 
            padding: 12px 15px; 
            border-radius: 8px; 
            font-size: 0.95rem; 
            outline: none;
            height: 48px; /* Tinggi seragam */
        }

        select { 
            border: 1px solid var(--border); 
            background: #fff; 
            cursor: pointer;
        }
        select:focus { border-color: var(--primary); ring: 2px solid rgba(30,60,114,0.1); }

        .btn-check { 
            background: #27ae60; 
            color: white; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-check:hover { background: #219150; }

        /* =========================================
           4. TABLE & RESULTS
           ========================================= */
        .result-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden; /* Round corners for table */
        }

        .stats-summary {
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; color: var(--text-main);
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            max-height: 600px; /* Scroll vertical jika data banyak */
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; /* Mencegah tabel gepeng di HP */
        }

        th { 
            background: var(--primary); 
            color: white; 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.8rem; 
            letter-spacing: 0.5px;
            position: sticky; /* Sticky Header */
            top: 0;
            z-index: 10;
        }

        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        
        tr:hover { background-color: #f8fbff; }
        tr:last-child td { border-bottom: none; }

        /* Badges & Buttons */
        .badge-count { 
            background: #fff0f0; color: var(--accent); 
            padding: 4px 12px; border-radius: 20px; 
            font-weight: 700; font-size: 0.9rem; border: 1px solid #ffcccc;
        }

        .btn-detail {
            background: white; border: 1px solid var(--secondary); color: var(--secondary);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-detail:hover { background: var(--secondary); color: white; }

        .spinner { text-align: center; padding: 40px; color: var(--primary); display: none; }
        .hidden { display: none !important; }

        /* =========================================
           5. MODAL
           ========================================= */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
            padding: 20px;
        }
        .modal-content {
            background: white; width: 100%; max-width: 480px; 
            border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 0; max-height: 60vh; overflow-y: auto; }
        
        .detail-item {
            padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }
        .detail-item:last-child { border-bottom: none; }

        /* =========================================
           6. DESKTOP OPTIMIZATION (min-width: 900px)
           ========================================= */
        @media (min-width: 900px) {
            body { padding: 40px; }
            .container { max-width: 1100px; margin: 0 auto; }

            /* Header menjadi Horizontal (Judul Kiri, Tab Kanan) */
            .dashboard-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 15px 30px;
            }
            .mode-switch-container { width: 300px; margin: 0; }

            /* Grid Layout untuk Filter */
            .controls-card { padding: 30px; }
            
            /* Jika mode Per Kelas aktif, gunakan Grid 3 Kolom */
            .controls-grid.filter-active {
                display: grid;
                grid-template-columns: 1fr 1fr 200px; /* Jenjang, Kelas, Tombol Fixed */
                gap: 20px;
                align-items: end; /* Ratakan tombol ke bawah sejajar input */
            }

            /* Jika mode Semua Siswa, Tombol di kiri saja atau full width kecil */
            .controls-grid:not(.filter-active) .btn-check {
                width: 250px;
            }

            /* Table Refinements */
            th, td { padding: 18px 25px; }
            .badge-count { font-size: 1rem; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="dashboard-header">
        <h1>üìä Monitor Kedisiplinan</h1>
        <div class="mode-switch-container">
            <button class="mode-btn active" onclick="setMode('all')" id="btn-all">Semua Data</button>
            <button class="mode-btn" onclick="setMode('class')" id="btn-class">Filter Kelas</button>
        </div>
    </div>

    <div class="controls-card">
        <div id="controls-grid" class="controls-grid">
            
            <div id="class-inputs-wrapper" style="display: contents;">
                <div class="form-group class-input hidden">
                    <label>Jenjang Pendidikan</label>
                    <select id="sel-jenjang" onchange="updateKelasOptions()">
                        <option value="" disabled selected>Pilih Jenjang...</option>
                        <option value="X">Kelas X</option>
                        <option value="XI">Kelas XI</option>
                        <option value="XII">Kelas XII</option>
                    </select>
                </div>
                <div class="form-group class-input hidden">
                    <label>Nama Kelas</label>
                    <select id="sel-kelas" disabled>
                        <option value="" disabled selected>...</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="desktop-spacer" style="opacity: 0;">&nbsp;</label>
                <button class="btn-check" onclick="fetchData()">
                    <span>üîç</span> TAMPILKAN DATA
                </button>
            </div>
        </div>
    </div>

    <div id="loading" class="spinner">
        <svg width="50" height="50" viewBox="0 0 50 50" style="animation: spin 1s linear infinite;">
            <circle cx="25" cy="25" r="20" fill="none" stroke="#1e3c72" stroke-width="4" stroke-linecap="round"></circle>
        </svg>
        <p style="margin-top: 15px; font-weight: 500;">Mengambil Data Terbaru...</p>
    </div>

    <div id="result-container" class="result-card hidden">
        <div class="stats-summary">
            <span>Daftar Siswa Terlambat</span>
            <span style="background: #e3f2fd; color: #1565c0; padding: 5px 10px; border-radius: 6px; font-size: 0.85rem;">
                Total: <span id="total-students">0</span>
            </span>
        </div>
        
        <div class="table-responsive">
            <table id="data-table">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">No</th>
                        <th>Nama Lengkap</th>
                        <th>Kelas</th>
                        <th style="text-align: center;">Total Poin</th>
                        <th style="text-align: center; width: 120px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalDetail" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" style="font-size: 1.1rem; margin:0;">Detail Siswa</h3>
            <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modal-loading" style="text-align:center; padding:30px;">‚è≥ Memuat...</div>
            <div id="modal-list"></div>
        </div>
        <div style="padding:15px; text-align:right; border-top:1px solid #eee;">
            <button onclick="closeModal()" style="padding:8px 20px; border:1px solid #ccc; background:#fff; border-radius:6px; cursor:pointer;">Tutup</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // CONFIG URL
    // ==========================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXIlrXJCqGY0GxnJBKFmU1GMM6doWmUHLo1jffSufMsPsLnO8JvJHk1flOfcxcq9ncCQ/exec"; 

    const dataKelas = {
        "X": ["X - A", "X - B", "X - C", "X - D", "X - E", "X - F"],
        "XI": ["XI - A", "XI - B", "XI - C", "XI - D", "XI - E", "XI - F", "XI - G"],
        "XII": ["XII - A", "XII - B", "XII - C", "XII - D", "XII - E", "XII - F", "XII - G"] 
    };

    let currentMode = "all";

    function setMode(mode) {
        currentMode = mode;
        
        // Update Tombol Tab
        document.getElementById('btn-all').className = mode === 'all' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btn-class').className = mode === 'class' ? 'mode-btn active' : 'mode-btn';
        
        const controlsGrid = document.getElementById('controls-grid');
        const classInputs = document.querySelectorAll('.class-input');

        if (mode === 'class') {
            // Tampilkan Input Kelas
            classInputs.forEach(el => el.classList.remove('hidden'));
            // Aktifkan Grid Layout Desktop
            controlsGrid.classList.add('filter-active');
        } else {
            // Sembunyikan Input Kelas
            classInputs.forEach(el => el.classList.add('hidden'));
            // Matikan Grid Layout Desktop (Balik ke default)
            controlsGrid.classList.remove('filter-active');
        }
        
        document.getElementById('result-container').classList.add('hidden');
    }

    function updateKelasOptions() {
        const jenjang = document.getElementById("sel-jenjang").value;
        const selKelas = document.getElementById("sel-kelas");
        selKelas.innerHTML = '<option value="" disabled selected>Pilih Kelas...</option>';
        selKelas.disabled = false;
        if (dataKelas[jenjang]) {
            dataKelas[jenjang].forEach(kelas => {
                let opt = document.createElement("option");
                opt.value = kelas;
                opt.textContent = kelas;
                selKelas.appendChild(opt);
            });
        }
    }

    function fetchData() {
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');
        const tbody = document.getElementById('table-body');
        const totalStudents = document.getElementById('total-students');
        
        let payload = { action: "getLateReport", mode: currentMode };

        if (currentMode === 'class') {
            const kelasDipilih = document.getElementById('sel-kelas').value;
            if (!kelasDipilih) { alert("Silakan pilih Kelas terlebih dahulu."); return; }
            payload.kelas = kelasDipilih;
        }

        loading.style.display = 'block';
        resultContainer.classList.add('hidden');
        tbody.innerHTML = "";

        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.result === "success") {
                const siswaList = data.data;
                if (siswaList.length === 0) { alert("Tidak ada data ditemukan."); return; }

                resultContainer.classList.remove('hidden');
                totalStudents.innerText = siswaList.length;

                let no = 1;
                siswaList.forEach(siswa => {
                    tbody.innerHTML += `
                        <tr>
                            <td style="text-align: center; color: #888;">${no++}</td>
                            <td><div style="font-weight:600; color:#333;">${siswa.nama}</div></td>
                            <td>${siswa.kelas}</td>
                            <td style="text-align: center;"><span class="badge-count">${siswa.poin}</span></td>
                            <td style="text-align: center;">
                                <button class="btn-detail" onclick="viewDetail('${siswa.nama}')">Lihat Detail</button>
                            </td>
                        </tr>
                    `;
                });
            } else { alert("Gagal mengambil data."); }
        })
        .catch(err => { loading.style.display = 'none'; alert("Error koneksi server."); });
    }

    function viewDetail(namaSiswa) {
        const modal = document.getElementById('modalDetail');
        const list = document.getElementById('modal-list');
        const loading = document.getElementById('modal-loading');
        const title = document.getElementById('modal-title');

        modal.style.display = 'flex';
        title.innerText = "Detail: " + namaSiswa;
        list.innerHTML = "";
        loading.style.display = 'block';

        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getStudentDetail", nama: namaSiswa }) })
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.result === "success") {
                if (data.details.length === 0) {
                    list.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Belum ada riwayat.</div>";
                } else {
                    data.details.forEach(item => {
                        let d = new Date(item.waktu);
                        let tgl = d.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short', year:'numeric'});
                        let jam = d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                        list.innerHTML += `
                            <div class="detail-item">
                                <div>
                                    <div style="font-weight:600; color:#333;">${tgl}</div>
                                    <div style="font-size:0.85rem; color:#666;">Pukul ${jam} WIB</div>
                                </div>
                                <div style="font-size:0.85rem; font-weight:700; color:#1e3c72;">${item.info || 'Tercatat'}</div>
                            </div>
                        `;
                    });
                }
            } else { list.innerHTML = "<div style='color:red; text-align:center'>Gagal memuat.</div>"; }
        })
        .catch(() => { loading.style.display='none'; list.innerHTML = "<div style='color:red; text-align:center'>Koneksi Error.</div>"; });
    }

    function closeModal() { document.getElementById('modalDetail').style.display = 'none'; }
    
    // Animasi Spin
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(styleSheet);
</script>

</body>
</html>
